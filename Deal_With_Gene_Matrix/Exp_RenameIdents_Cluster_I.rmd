---
title: "process_batchcorrection"
author: "zhong"
date: "8/12/2021"
output: html_document
---

## Clear workspace
```{r packages, cache=FALSE}
rm(list=ls())
set.seed(123)
WORKDIR = '~/Singel-Cell-Analysis-From-Zero/Deal_With_Gene_Matrix/'
setwd(WORKDIR)


library(Seurat)
library(ggplot2)
library(patchwork)
library(dplyr)
library(showtext)  
library(ggprism)
library(rstatix)
```

```{r setting}
showtext_auto(TRUE)
font_add("Times New Roman", regular = "/usr/share/fonts/truetype/msttcorefonts/Times_New_Roman.ttf")
PATH = "../Figure1_Cluster_TMP"
if (!dir.exists(PATH)){
  dir.create(path = PATH, recursive = TRUE)
} 
theme_me <- theme(text = element_text(family="Times New Roman", size=10.5, face = "plain"),
                  axis.text = element_text(family="Times New Roman", size=10.5, face = "plain"),
                  plot.caption = element_text(family="Times New Roman", size=10.5, face = "italic"),
                  plot.title = element_text(family="Times New Roman", size=12, face = "bold"),
                  plot.subtitle = element_text(family="Times New Roman", size=11, face = "bold"),
                  legend.title = element_text(family="Times New Roman", size=11, face = "plain"),
                  strip.text = element_text(family="Times New Roman", size=10.5, face = "italic"))

theme_set(theme_me)
```

## Data loading
# To demonstrate mapping to this multimodal reference, we will use a dataset of 2,700 PBMCs generated by 10x Genomics and available via `SeuratData`. 
# Noted that sct transformed can also be replaced with NormalizeData(), ScaleData() and FindVariableFeatures()
```{r loadrds}
pbmc <- readRDS("../output/ASSHD_pbmc_orig.rds")
DefaultAssay(pbmc) <- 'RNA'
pbmc.norm <- NormalizeData(pbmc)
all.genes <- rownames(pbmc.norm)
pbmc.scale <- ScaleData(pbmc.norm, features = all.genes)
```


## Cluster I: 
# T（"CD3D", "CD3E", "CD3G"）、B（"CD37", "CD79A", "BLNK", "CD19", "CD79B", "MS4A1"）、
# NK（KLRF1、NCAM1）、Mono（LYZ、CD14、FCGR3A/CD16）、DC（CD1C、CLEC10A、LILRA4）、Platelet（PPBP、PF4）
```{r clusterI}
pbmc.input <- pbmc.scale
Idents(pbmc.input) <- "integrated_snn_res.0.4"
DefaultAssay(pbmc.input) <- "RNA"
clusterI.T <- c("CD3D", "CD3E", "CD3G")
clusterI.cd4 <- c("CD4")
clusterI.B <- c("CD37", "CD79A", "BLNK", "CD19", "CD79B", "MS4A1")
clusterI.NK <- c("CCL3", "CD160", "CD247", "GNLY", "GZMB", "NKG7", "FCGR3A", "FCGR3B", "KLRB1", "KLRC1", "KLRD1", "KLRF1", "KLRK1", "NCAM1", "ID2")
clusterI.Mono <- c("CD14", "CD16", "FCGR3A", "CD68", "S100A12")
clusterI.DC <- c("CLEC4C", "IL3RA", "NRP1", "CD1C", "CST3", "FCER1A", "CD123", "GZMB")
clusterI.Platelet <- c("CD41", "PPBP", "PF4")
plot.cd3d <- VlnPlot(pbmc.input, "CD3D") + theme_me
plot.cd4vln <- VlnPlot(pbmc.input, clusterI.cd4) + theme_me
plot.t.feat <- FeaturePlot(pbmc.input, reduction = "umap", clusterI.T) + theme_me
plot.b.feat <- FeaturePlot(pbmc.input, reduction = "umap", clusterI.B) + theme_me
plot.nk.feat <- FeaturePlot(pbmc.input, reduction = "umap", clusterI.NK) + theme_me
plot.mono.feat <- FeaturePlot(pbmc.input, reduction = "umap", clusterI.Mono) + theme_me
plot.dc.feat <- FeaturePlot(pbmc.input, reduction = "umap", clusterI.DC) + theme_me
plot.platelet.feat <- FeaturePlot(pbmc.input, reduction = "umap", clusterI.Platelet) + theme_me

filename = paste(PATH, "/plot.cd3d.vln.png",sep="") # cluster_markers_feat.pdf is large for publication, this png is for check
png(filename, width = 1400, height = 1000) 
print(plot.cd3d)
dev.off()
filename = paste(PATH, "/plot.cd4.vln.png",sep="") # cluster_markers_feat.pdf is large for publication, this png is for check
png(filename, width = 1400, height = 1000) 
print(plot.cd4vln)
dev.off()
filename = paste(PATH, "/plot.t.feat.png",sep="") # cluster_markers_feat.pdf is large for publication, this png is for check
png(filename, width = 1400, height = 1000) 
print(plot.t.feat)
dev.off()
filename = paste(PATH, "/plot.b.feat.png",sep="") # cluster_markers_feat.pdf is large for publication, this png is for check
png(filename, width = 1400, height = 1000) 
print(plot.b.feat)
dev.off()
filename = paste(PATH, "/plot.nk.feat.png",sep="") # cluster_markers_feat.pdf is large for publication, this png is for check
png(filename, width = 1400, height = 1000) 
print(plot.nk.feat)
dev.off()
filename = paste(PATH, "/plot.mono.feat.png",sep="") # cluster_markers_feat.pdf is large for publication, this png is for check
png(filename, width = 1400, height = 1000) 
print(plot.mono.feat)
dev.off()
filename = paste(PATH, "/plot.dc.feat.png",sep="") # cluster_markers_feat.pdf is large for publication, this png is for check
png(filename, width = 1400, height = 1000) 
print(plot.dc.feat)
dev.off()
filename = paste(PATH, "/plot.platelet.feat.png",sep="") # cluster_markers_feat.pdf is large for publication, this png is for check
png(filename, width = 1400, height = 1000) 
print(plot.platelet.feat)
dev.off()
```


```{r writemarkers}
pbmc.input <- pbmc.scale
Idents(pbmc.input) <- "integrated_snn_res.0.4"
DefaultAssay(pbmc.input) <- "RNA"
pbmc.markers <- FindAllMarkers(pbmc.input, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.5)
pbmc.markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_log2FC) -> top10
pbmc.markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_log2FC) -> top5
filename <- paste("allmarkers_top10_normscale.csv", sep = "")
write.csv(top10, file =paste(PATH, filename, sep="/")) 
filename <- paste("allmarkers_normscale.csv", sep = "")
write.csv(pbmc.markers, file =paste(PATH, filename, sep="/")) 

```

```{r heatmap}
pbmc.input <- pbmc.scale
Idents(pbmc.input) <- "integrated_snn_res.0.4"
DefaultAssay(pbmc.input) <- "RNA"
pbmc.heat <- subset(x = pbmc.input, downsample = 100)
# levels(pbmc.heat) <- c("1", "2", "4", "0", "6", "7", "3", "5", "11", "13", "8", "14", "9", "10", "12")
plot.heatmap <- DoHeatmap(pbmc.heat, features = top10$gene) + theme_me
# filename = paste(PATH, "/plot.heatmap.png",sep="") # 
# png(filename, width = 1400, height = 1000) 
filename = paste(PATH, "/plot.heatmap.pdf",sep="") # 
pdf(filename, width=15, height=15)
print(plot.heatmap)
dev.off()
```

```{r tc.rename.idents.ASSILDHD}
print("Loading data: ASSHD_pbmc_orig.rds")
pbmc <- readRDS("../output/ASSHD_pbmc_orig.rds")
print("Loaded")  

Idents(pbmc) <- "integrated_snn_res.0.4"

pbmc <- RenameIdents(pbmc, 
            "0" = "CD14 Mono", 
            "1" = "TEM",
            "2" = "Naive T",
            "3" = "NK",
            "4" = "TCM",
            "5" = "B", 
            "6" = "CD16 Mono", 
            "7" = "doublet",
            "8" = "gdT",
            "9" = "Platelet",
            "10" = "DC",
            "11" = "Pro T", 
            "12" = "pDC",
            "13" = "doublet")
cluster.names <-  c("Naive T", "TCM", "TEM", "gdT", "Pro T", "NK", "CD14 Mono", "CD16 Mono", "B", "DC", "pDC", "Platelet", "doublet")
levels(x = pbmc) <- cluster.names
plot.cluster.primary <- DimPlot(pbmc, reduction = "umap", label = "TRUE", label.size = 3, repel = TRUE)
pbmc[["celltypeI"]] <- Idents(pbmc)
```

```{r tc.rename.idents.ASSILDHD}
print("Loading data: ASSHD_pbmc_orig.rds")
pbmc <- readRDS("../output/ASSHD_pbmc_orig.rds")
print("Loaded")  

Idents(pbmc) <- "integrated_snn_res.0.4"
pbmc <- RenameIdents(pbmc, 
            "0" = "CD14 Mono", 
            "1" = "T",
            "2" = "T",
            "3" = "NK",
            "4" = "T",
            "5" = "B", 
            "6" = "CD16 Mono", 
            "7" = "doublet",
            "8" = "T",
            "9" = "Platelet",
            "10" = "DC",
            "11" = "T", 
            "12" = "pDC",
            "13" = "doublet")
cluster.names <-  c("T", "NK", "CD14 Mono", "CD16 Mono", "B", "DC", "pDC", "Platelet", "doublet")
levels(x = pbmc) <- cluster.names
plot.cluster.primary <- DimPlot(pbmc, reduction = "umap", label = "TRUE", label.size = 3, repel = TRUE)
pbmc[["celltypeI"]] <- Idents(pbmc)

saveRDS(pbmc, file = "../output/ASSHD_pbmc_cluster_com.rds")
```